# Task Plan: Codebase Cleanup and Active Learning Design

## Date: 2025-01-31

## Objective
1. Clean up duplicate/deprecated code in the codebase
2. Fix variable mapping inconsistencies between models
3. Design a principled update function interface for active learning

## Current State Analysis

### Variable Mapping Issues Identified

1. **Different Naming Conventions Across Components**:
   - SCMs use various schemes:
     - Simple: `X`, `Y`, `Z` (fork, collider)
     - Indexed: `X0`, `X1`, `X2`, ... (chain, complex)
     - Semantic: `treatment`, `outcome`, `confounder`
   - Models use internal logic:
     - Surrogate: Assumes ordered indices (0, 1, 2, ...)
     - Policy: Uses tensor positions
     - Evaluator: Passes variable lists

2. **Key Problem Locations**:
   - `buffer_to_three_channel_tensor()`: Returns `var_order` but not always used consistently
   - `buffer_to_five_channel_tensor()`: Has complex variable mapping logic
   - `create_surrogate_fn_wrapper()`: Contains hardcoded variable name inference
   - `continuous_surrogate_integration.py`: Lines 366-391 have complex mapping logic
   - Model interfaces: Inconsistent handling of variable names vs indices

3. **Current Workarounds**:
   - Multiple "wrapper" functions to translate between formats
   - Hardcoded assumptions about variable names
   - Complex inference logic scattered throughout codebase

## Implementation Plan

### Morning Tasks (COMPLETED: 9:00-12:00)

### Afternoon Tasks (IN PROGRESS)

### Task 2: Fix Variable Mapping (13:00-14:00)
- [ ] Create `src/causal_bayes_opt/utils/variable_mapping.py`
- [ ] Implement standardized variable naming utilities
- [ ] Update all components to use consistent interface
- [ ] Test with existing checkpoints

### Task 3: Safe Codebase Cleanup (14:00-15:30)
- [ ] Create inventory of all files
- [ ] Trace dependencies
- [ ] Move deprecated files to archive/
- [ ] Commit with detailed message

### Task 4: Design Update Function Interface (15:30-16:30)
- [ ] Design UpdateContext dataclass
- [ ] Create UpdateFunction protocol
- [ ] Implement basic strategies
- [ ] Integrate with evaluator

## Design Decisions Log
[APPEND ONLY - Record all design decisions as they're made]

### 2025-01-31 09:15 - Variable Mapping Analysis
- Identified that the core issue is lack of a single source of truth for variable names
- Models should not infer variable names, they should be explicitly provided
- Need to maintain backward compatibility with existing checkpoints

### 2025-01-31 11:00 - Variable Mapping Solution Design
- Created `VariableMapper` class as single source of truth
- Always use alphabetical sorting for consistency
- Provide bidirectional name<->index mapping
- Replace all hardcoded variable inference with explicit mapping
- Include variable order in posteriors for debugging

## Problems & Solutions
[APPEND ONLY - Document issues encountered and resolutions]

### Problem 1: Variable name inference in surrogate wrapper
- Location: `continuous_surrogate_integration.py:362-391`
- Issue: Hardcoded logic to guess variable names based on context
- Solution: Pass variable names explicitly through the interface

### Solution 1: Created unified variable mapping (11:00)
- Created `utils/variable_mapping.py` with `VariableMapper` class
- Updated `create_surrogate_fn_wrapper` to accept explicit variables
- Maintained backward compatibility with deprecation warning
- Still need to update all callers to pass variables

## Progress Updates
[APPEND ONLY - Regular updates on implementation progress]

### 09:00 - Started documentation phase
- Analyzing variable mapping issues across codebase
- Found multiple inconsistent naming conventions
- Identified key problem locations

### 09:30 - Deep dive into surrogate integration
- Found complex variable inference logic
- Multiple wrapper functions creating confusion
- Need unified approach

### 10:00 - Analyzing tensor converters
- `buffer_to_three_channel_tensor` returns var_order
- `buffer_to_five_channel_tensor` has its own logic
- Need to consolidate

### 10:30 - Complete Variable Mapping Analysis
**Key Findings:**

1. **Three-channel converter (three_channel_converter.py)**:
   - Line 56: `variable_order = sorted(buffer.get_variable_coverage())`
   - Uses alphabetical sorting of variables
   - Returns variable order properly

2. **Five-channel converter (five_channel_converter.py)**:
   - Line 70: Also uses `sorted(buffer.get_variable_coverage())`
   - Consistent with 3-channel converter
   - Line 75: `target_idx = variable_order.index(target_variable)`

3. **Surrogate wrapper (continuous_surrogate_integration.py:362-391)**:
   - HARDCODED variable name inference based on patterns
   - Assumes X/Y/Z for 3-var SCMs
   - Assumes X0/X1/X2 for numbered SCMs
   - This is the MAIN PROBLEM - models shouldn't guess names

4. **Model interfaces**:
   - Pass variable lists but not always used consistently
   - Some functions use indices, others use names
   - No single source of truth

**Root Cause**: The surrogate wrapper tries to "guess" variable names instead of using the provided variable order from the tensor converters. This creates mismatches when SCMs use different naming conventions.

### 11:30 - Starting Cleanup Task
- Created CLEANUP_INVENTORY.md
- Identified main entry points: train_acbo_methods.py and evaluate_acbo_methods.py
- Traced dependencies to avoid deleting important files
- Found scripts/core contains important utilities used by notebooks